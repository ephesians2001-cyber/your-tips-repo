name: Archive Daily Tips

on:
  schedule:
    # Runs at 12:00 AM GMT every day
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  archive-tips:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Archive tips and cleanup old files
        run: |
          TODAY=$(TZ=GMT date +%Y-%m-%d)
          CUTOFF_DATE=$(TZ=GMT date -d '7 days ago' +%Y-%m-%d)
          
          echo "ğŸ“… Today: $TODAY"
          echo "ğŸ—‘ï¸  Cutoff date: $CUTOFF_DATE"
          
          archive_file() {
            local source=$1
            local dest_folder=$2
            local filename="${TODAY}.json"
            
            if [ -f "$source" ]; then
              mkdir -p "past/$dest_folder"
              cp "$source" "past/$dest_folder/$filename"
              echo "âœ… Archived $source â†’ past/$dest_folder/$filename"
            else
              echo "âš ï¸  Source file not found: $source"
            fi
          }
          
          archive_file "safe-tips.json" "safe"
          archive_file "single-tips.json" "single"
          archive_file "sure-tips-vip.json" "sure"
          archive_file "big-win-tips-vip.json" "bigwin"
          archive_file "king-vip.json" "king"
          archive_file "legend-vip.json" "legend"
          
          echo ""
          echo "ğŸ§¹ Cleaning up files older than 7 days..."
          
          cleanup_folder() {
            local folder=$1
            
            if [ -d "past/$folder" ]; then
              find "past/$folder" -name "*.json" -type f | while read file; do
                filename=$(basename "$file")
                file_date="${filename%.json}"
                
                file_timestamp=$(date -d "$file_date" +%s 2>/dev/null || echo 0)
                cutoff_timestamp=$(date -d "$CUTOFF_DATE" +%s)
                
                if [ $file_timestamp -lt $cutoff_timestamp ] && [ $file_timestamp -ne 0 ]; then
                  rm "$file"
                  echo "ğŸ—‘ï¸  Deleted old file: $file"
                fi
              done
            fi
          }
          
          cleanup_folder "safe"
          cleanup_folder "single"
          cleanup_folder "sure"
          cleanup_folder "bigwin"
          cleanup_folder "king"
          cleanup_folder "legend"

      - name: Commit and push changes
        run: |
          git add past/
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            TODAY=$(TZ=GMT date +%Y-%m-%d)
            git commit -m "ğŸ¤– Archive tips for $TODAY and cleanup old files"
            git push
            echo "âœ… Changes pushed successfully"
          fi

      - name: Summary
        run: |
          echo "ğŸ“Š Archive Summary:"
          echo "===================="
          for folder in safe single sure bigwin king legend; do
            if [ -d "past/$folder" ]; then
              count=$(find "past/$folder" -name "*.json" -type f | wc -l)
              echo "ğŸ“ past/$folder: $count files"
            fi
          done
