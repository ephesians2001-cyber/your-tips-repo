name: Archive Daily Tips

on:
  schedule:
    # Runs at 12:00 AM GMT every day
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  archive-tips:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Archive tips and cleanup old files
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          CUTOFF_TIMESTAMP=$(date -u -d '7 days ago' +%s)
          
          echo "ğŸ“… Today: $TODAY"
          echo "ğŸ—‘ï¸  Cutoff timestamp: $CUTOFF_TIMESTAMP"
          
          archive_file() {
            local source=$1
            local dest_folder=$2
            local filename="${TODAY}.json"
            
            if [ -f "$source" ]; then
              mkdir -p "past/$dest_folder"
              cp "$source" "past/$dest_folder/$filename"
              echo "âœ… Archived $source â†’ past/$dest_folder/$filename"
              return 0
            else
              echo "âš ï¸  Source file not found: $source"
              return 1
            fi
          }
          
          echo "ğŸ“¦ Archiving current tips..."
          archive_file "safe-tips.json" "safe"
          archive_file "single-tips.json" "single"
          archive_file "sure-tips-vip.json" "sure"
          archive_file "big-win-tips-vip.json" "bigwin"
          archive_file "king-vip.json" "king"
          archive_file "legend-vip.json" "legend"
          
          echo ""
          echo "ğŸ§¹ Cleaning up files older than 7 days..."
          
          cleanup_folder() {
            local folder=$1
            
            if [ -d "past/$folder" ]; then
              echo "Checking folder: past/$folder"
              for file in past/$folder/*.json; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  file_date="${filename%.json}"
                  
                  if [[ $file_date =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                    file_timestamp=$(date -u -d "$file_date" +%s 2>/dev/null || echo 0)
                    
                    if [ $file_timestamp -ne 0 ] && [ $file_timestamp -lt $CUTOFF_TIMESTAMP ]; then
                      rm "$file"
                      echo "ğŸ—‘ï¸  Deleted old file: $file (date: $file_date)"
                    else
                      echo "ğŸ“Œ Keeping file: $file (date: $file_date)"
                    fi
                  else
                    echo "âš ï¸  Skipping invalid filename: $file"
                  fi
                fi
              done
            else
              echo "âš ï¸  Folder not found: past/$folder"
            fi
          }
          
          cleanup_folder "safe"
          cleanup_folder "single"
          cleanup_folder "sure"
          cleanup_folder "bigwin"
          cleanup_folder "king"
          cleanup_folder "legend"

      - name: Commit and push changes
        run: |
          git add past/ || true
          
          if git diff --staged --quiet; then
            echo "ğŸ“­ No changes to commit"
          else
            TODAY=$(date -u +%Y-%m-%d)
            git commit -m "ğŸ¤– Archive tips for $TODAY and cleanup old files"
            git push
            echo "âœ… Changes pushed successfully"
          fi

      - name: Summary
        run: |
          echo "ğŸ“Š Archive Summary:"
          echo "===================="
          for folder in safe single sure bigwin king legend; do
            if [ -d "past/$folder" ]; then
              count=$(find "past/$folder" -name "*.json" -type f | wc -l)
              echo "ğŸ“ past/$folder: $count files"
              ls -lh "past/$folder/"
            else
              echo "âŒ past/$folder: folder does not exist"
            fi
          done
