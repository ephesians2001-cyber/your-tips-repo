name: Archive Daily Tips

on:
  schedule:
    # Runs at 12:00 AM GMT every day
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  archive-tips:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # Fetch all history to check diffs later
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Archive tips and cleanup old files
        run: |
          # üö® FIX: Set ARCHIVE_DATE to YESTERDAY (date the tips were live)
          ARCHIVE_DATE=$(date -u -d 'yesterday' +%Y-%m-%d)
          CUTOFF_TIMESTAMP=$(date -u -d '7 days ago' +%s)
          
          echo "üìÖ Tips will be archived for: $ARCHIVE_DATE"
          echo "üóëÔ∏è  Cutoff timestamp: $CUTOFF_TIMESTAMP"
          
          # üõ†Ô∏è Define the Source Files and Destination Folders
          # YOU MUST CONFIRM THESE SOURCE FILE NAMES (left side) ARE CORRECT
          declare -A ARCHIVE_MAP=(
            ["safe-tips.json"]="safe"
            ["single-tips.json"]="single"
            ["sure-tips-vip.json"]="sure"
            ["big-win-tips-vip.json"]="bigwin"
            ["king-vip.json"]="king"
            ["legend-vip.json"]="legend"
          )
          
          echo "üì¶ Archiving current tips..."
          
          for source_file in "${!ARCHIVE_MAP[@]}"; do
            dest_folder="${ARCHIVE_MAP[$source_file]}"
            dest_file="past/$dest_folder/$ARCHIVE_DATE.json"
            
            if [ -f "$source_file" ]; then
              mkdir -p "past/$dest_folder"
              cp "$source_file" "$dest_file"
              echo "‚úÖ Archived $source_file ‚Üí $dest_file"
            else
              echo "‚ö†Ô∏è  Source file not found: $source_file (Skipping archive for this type)"
            fi
          done
          
          echo ""
          echo "üßπ Cleaning up files older than 7 days..."
          
          # Use the keys from the map for cleanup
          for dest_folder in "${ARCHIVE_MAP[@]}"; do
            cleanup_folder="past/$dest_folder"
            
            if [ -d "$cleanup_folder" ]; then
              echo "Checking folder: $cleanup_folder"
              find "$cleanup_folder" -name "*.json" -type f -print | while read file; do
                filename=$(basename "$file")
                file_date="${filename%.json}"
                
                # Check for YYYY-MM-DD format
                if [[ $file_date =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                  file_timestamp=$(date -u -d "$file_date" +%s 2>/dev/null || echo 0)
                  
                  if [ "$file_timestamp" -ne 0 ] && [ "$file_timestamp" -lt "$CUTOFF_TIMESTAMP" ]; then
                    rm "$file"
                    echo "üóëÔ∏è  Deleted old file: $file (date: $file_date)"
                  else
                    # Only show keeping files if they are within the 7-day window
                    :
                  fi
                else
                  echo "‚ö†Ô∏è  Skipping invalid filename: $file"
                fi
              done
            else
              echo "‚ùå Folder not found for cleanup: $cleanup_folder"
            fi
          done

      - name: Commit and push changes
        run: |
          git add past/ || true
          
          if git diff --staged --quiet; then
            echo "üì≠ No changes to commit. Nothing new was archived."
          else
            ARCHIVE_DATE=$(date -u -d 'yesterday' +%Y-%m-%d)
            # Use --allow-empty-message to commit cleanup changes even if no tips were archived
            git commit -m "ü§ñ Archive tips for $ARCHIVE_DATE and cleanup old files" --allow-empty
            git push
            echo "‚úÖ Changes pushed successfully"
          fi
